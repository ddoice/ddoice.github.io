<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
</head>
<style>
  body { 
    background: #111;
    margin: 0;
    padding: 0;
  }
  .title {
    width: 100%;
    text-align: center;
    position: fixed;
    color: white;
    bottom: 0;
    left: 0;
    font-family: sans-serif;
    font-size: 18px;
  }
  .count {
    padding: 8px;
    position: fixed;
    color: white;
    top: 0;
    left: 0;
    font-family: monospace;
    font-size: 15px;
  }
  .time {
    padding: 8px;
    position: fixed;
    color: white;
    top: 0;
    right: 0;
    font-family: monospace;
    font-size: 15px;
  }   
</style>

<h1 class="title">Boarding pass scan (beta) v.1.5</h1>
<h1 class="count">Scan count <span>-</span></h1>
<h1 class="time">Avg scan time <span>-</span>ms</h1>
<video id="stream" style="width: 100vw; height: 100vh;" />

<script src="//cdn.jsdelivr.net/npm/eruda"></script>
<script>eruda.init();</script>

<script>

let scanCount = 0;
let average = 0;
let last = 0;

function updateDom() {
  const timeNode = document.querySelector('.time span');
  const countNode = document.querySelector('.count span');
  timeNode.innerHTML = average;
  countNode.innerHTML = scanCount;
}
  
function updateStats(initial) {
  scanCount += 1;
  last = Date.now() - initial;
  average = scanCount > 1 ? (average/scanCount) + (last/scanCount) : last;
}

const main = async () => { 
  
const stream = await navigator.mediaDevices.getUserMedia({
  video: {
    facingMode: {
      ideal: "environment"
    }
  },
  audio: false
});
  
const videoEl = document.querySelector("#stream");
videoEl.srcObject = stream;
await videoEl.play();

const barcodeDetector = new BarcodeDetector({formats: ['pdf417','qr_code']});
const vamos = async () => {
  const initial = Date.now();
  const barcodes = await barcodeDetector.detect(videoEl);
  updateStats(initial);
  if (barcodes.length > 0) {
  alert(barcodes.map(barcode => barcode.rawValue));
  }
  setTimeout(vamos, 160);
  //window.requestAnimationFrame(vamos);
};
vamos();
};

main();
  
</script>

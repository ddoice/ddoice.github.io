<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
</head>
<style>
  body {
    background: #111;
    margin: 0;
    padding: 0;
  }

  .title {
    width: 100%;
    text-align: center;
    position: fixed;
    color: white;
    bottom: 35px;
    left: 0;
    font-family: sans-serif;
    font-size: 15px;
  }

  .count {
    padding: 8px;
    position: fixed;
    color: white;
    top: 0;
    left: 0;
    font-family: monospace;
    font-size: 15px;
  }

  .time {
    padding: 8px;
    position: fixed;
    color: white;
    top: 0;
    right: 0;
    font-family: monospace;
    font-size: 15px;
  }

  .success {
    padding: 8px;
    position: fixed;
    color: green;
    top: 24px;
    left: 0;
    font-family: monospace;
    font-size: 15px;
  }

  .fail {
    padding: 8px;
    position: fixed;
    color: red;
    top: 24px;
    right: 0;
    font-family: monospace;
    font-size: 15px;
  }

</style>

<h1 class="title">version</h1>
<h1 class="count">Scan count <span>-</span></h1>
<h1 class="time">Avg scan time <span>-</span>ms</h1>
<h1 class="success">Success <span>-</span></h1>
<h1 class="fail">Fail <span>-</span></h1>
<video id="stream" style="width: 100vw; height: 100vh;" />

<script src="//cdn.jsdelivr.net/npm/eruda"></script>
<script>eruda.init();</script>

<script>

  document.querySelector('.title').innerHTML = navigator.userAgent;

  if (typeof BarcodeDetector === 'undefined') {
    alert('API not supported by this browser');
  }

  let scanCount = 0;
  let average = 0;
  let last = 0;
  let fail=0;
  let success=0;      
  const minDelay = 200;

  function updateDom() {
    const timeNode = document.querySelector('.time span');
    const countNode = document.querySelector('.count span');
    const successNode = document.querySelector('.success span');
    const failNode = document.querySelector('.fail span');
    successNode.innerHTML = success;
    failNode.innerHTML = fail;
    timeNode.innerHTML = average.toFixed(2);
    countNode.innerHTML = scanCount;
  }

  function updateStats(initial) {
    last = Date.now() - initial;
    scanCount += 1;
    average = scanCount > 1 ? ((average * (scanCount - 1)) + last) / scanCount : last;
  }

  const setInRange = (value, range) => {
    if (!range) return NaN;
    let x = Math.min(range.max, Math.max(range.min, value));
    x = Math.round(x / range.step) * range.step;
    return x;
  };

  const main = async () => {

    const stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: {
          ideal: "environment"
        },
        //focusMode: 'manual',
        //focusDistance: 0.5,
        width: { ideal: 960 },
        height: { ideal: 1280 } 
      },
      audio: false
    });


    let track = stream.getVideoTracks()[0];
    let settings = track.getSettings();
    let width = settings.width;
    let height = settings.height;

    window.__stream = stream;

    document.querySelector('.title').innerHTML = `stream:${width}*${height}<br>${navigator.userAgent}`;

    const videoEl = document.querySelector("#stream");
    videoEl.srcObject = stream;
    await videoEl.play();


    const imageCapture = new ImageCapture(track);
    const { imageWidth, imageHeight } = await imageCapture.getPhotoCapabilities();
    const captureWidth = setInRange(960, imageWidth);
    const captureHeight = setInRange(1280, imageHeight);
    const photoSettings = width && height
      ? {
        imageWidth: captureWidth,
        imageHeight: captureHeight,
      }
      : null;

    console.log('photoSettings', photoSettings);
    

    const barcodeDetector = new BarcodeDetector({ formats: ['pdf417', 'qr_code', 'aztec'] });
    const vamos = async () => {
      const initial = Date.now();

      const imageBlob = await imageCapture.grabFrame();

      const imagen = new Image();
      imagen.src = URL.createObjectURL(imageBlob);
      await new Promise(resolve => {
        imagen.onload = resolve;
      });

      const barcodes = await barcodeDetector.detect(imagen);
      //const barcodes = await barcodeDetector.detect(videoEl);
      console.log('barcodes.length', barcodes.length);
      updateStats(initial);
      updateDom();
      if (barcodes.length > 0) {
        success+=1;
        //alert(barcodes.map(barcode => barcode.rawValue));
      } else {
        fail+=1;
      }
      console.log('last', last);
      setTimeout(vamos, minDelay);
    };
    vamos();
  };

  main();

</script>